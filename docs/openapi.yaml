openapi: 3.0.3
info:
  title: Prompt Monitor Dashboard API
  description: API for monitoring AI prompts across multiple devices, providing real-time insights and compliance tracking.
  version: 1.0.0
  contact:
    name: API Support
servers:
  - url: http://localhost:3000
    description: Development server
  - url: https://prompt-monitor-dashboard.vercel.app
    description: Production server

tags:
  - name: Statistics
    description: Dashboard statistics endpoints
  - name: Devices
    description: Device management endpoints
  - name: Prompts
    description: Prompt monitoring endpoints
  - name: Browsers
    description: Browser instance management endpoints
  - name: Extension
    description: Extension status endpoints
  - name: Compliance
    description: Compliance event endpoints

paths:
  /api/stats:
    get:
      tags:
        - Statistics
      summary: Get dashboard statistics
      description: Returns dashboard statistics including device counts and prompt metrics.
      operationId: getStats
      responses:
        "200":
          description: Successful response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StatsResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/devices:
    get:
      tags:
        - Devices
      summary: List all devices
      description: Returns a list of all devices with computed statistics. Supports filtering and searching.
      operationId: listDevices
      parameters:
        - name: search
          in: query
          description: Search by hostname, ID, or IP address
          required: false
          schema:
            type: string
        - name: status
          in: query
          description: Filter by device status
          required: false
          schema:
            $ref: "#/components/schemas/DeviceStatus"
      responses:
        "200":
          description: Successful response
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Device"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/devices/{id}:
    get:
      tags:
        - Devices
      summary: Get device details
      description: Returns detailed information about a specific device.
      operationId: getDevice
      parameters:
        - name: id
          in: path
          description: Device ID
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Successful response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Device"
        "404":
          description: Device not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/devices/{id}/prompts:
    get:
      tags:
        - Devices
        - Prompts
      summary: Get device prompts
      description: Returns all prompts captured from a specific device.
      operationId: getDevicePrompts
      parameters:
        - name: id
          in: path
          description: Device ID
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Successful response
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Prompt"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/devices/{id}/events:
    get:
      tags:
        - Devices
      summary: Get device events
      description: Returns all events associated with a device, including statistics.
      operationId: getDeviceEvents
      parameters:
        - name: id
          in: path
          description: Device ID
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Successful response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeviceEventsResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/devices/{id}/blocked:
    get:
      tags:
        - Devices
        - Prompts
      summary: Get blocked prompts
      description: Returns all blocked prompts (compliance events) for a device.
      operationId: getBlockedPrompts
      parameters:
        - name: id
          in: path
          description: Device ID
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Successful response
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/BlockedPrompt"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/devices/{id}/audit-trail:
    get:
      tags:
        - Devices
      summary: Get unified device audit trail
      description: Returns a unified chronological audit trail of all events (device events, prompts, compliance events, browser events) for a device.
      operationId: getDeviceAuditTrail
      parameters:
        - name: id
          in: path
          description: Device ID
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Successful response
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/AuditTrailItem"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/prompt/{id}:
    get:
      tags:
        - Prompts
      summary: Get prompt details
      description: Returns detailed information about a specific prompt.
      operationId: getPrompt
      parameters:
        - name: id
          in: path
          description: Prompt ID
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Successful response
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Prompt"
        "404":
          description: Prompt not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/devices/register:
    post:
      tags:
        - Devices
      summary: Register a new device
      description: Register a new device with its public key and metadata. This is called by the native agent on first run.
      operationId: registerDevice
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RegisterDeviceRequest"
      responses:
        "200":
          description: Device registered successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RegisterDeviceResponse"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/devices/heartbeat:
    post:
      tags:
        - Devices
      summary: Send device heartbeat
      description: Update device last_heartbeat timestamp and optionally update metadata. Requires authentication.
      operationId: deviceHeartbeat
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/HeartbeatRequest"
      responses:
        "200":
          description: Heartbeat recorded successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HeartbeatResponse"
        "401":
          description: Authentication required
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/prompt:
    post:
      tags:
        - Prompts
      summary: Capture a prompt
      description: Capture a single prompt from the extension. Requires authentication.
      operationId: capturePrompt
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CapturePromptRequest"
      responses:
        "200":
          description: Prompt captured successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CapturePromptResponse"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Authentication required
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/browsers/register:
    post:
      tags:
        - Browsers
      summary: Register a browser instance
      description: Register a browser instance discovered by the extension. Requires authentication.
      operationId: registerBrowser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RegisterBrowserRequest"
      responses:
        "200":
          description: Browser registered successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RegisterBrowserResponse"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Authentication required
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/browsers/heartbeat:
    post:
      tags:
        - Browsers
      summary: Send browser heartbeat
      description: Update browser instance last_seen timestamp. Requires authentication.
      operationId: browserHeartbeat
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/BrowserHeartbeatRequest"
      responses:
        "200":
          description: Heartbeat recorded successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BrowserHeartbeatResponse"
        "401":
          description: Authentication required
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/extension/status:
    post:
      tags:
        - Extension
      summary: Report extension status
      description: Report extension health status (enabled/disabled). Requires authentication.
      operationId: reportExtensionStatus
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ExtensionStatusRequest"
      responses:
        "200":
          description: Status reported successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ExtensionStatusResponse"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Authentication required
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/compliance/event:
    post:
      tags:
        - Compliance
      summary: Report compliance event
      description: Report a compliance violation or tampering attempt. Requires authentication.
      operationId: reportComplianceEvent
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ComplianceEventRequest"
      responses:
        "200":
          description: Event reported successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ComplianceEventResponse"
        "400":
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Authentication required
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

components:
  schemas:
    DeviceStatus:
      type: string
      enum: [active, inactive, warning, error, compliance]
      description: Device status

    StatsResponse:
      type: object
      properties:
        total_devices:
          type: integer
          description: Total number of devices
        active_devices:
          type: integer
          description: Number of active devices (heartbeat within last 5 minutes)
        inactive_devices:
          type: integer
          description: Number of inactive devices
        prompts_today:
          type: integer
          description: Number of prompts captured today
      required:
        - total_devices
        - active_devices
        - inactive_devices
        - prompts_today

    Device:
      type: object
      properties:
        id:
          type: string
          description: Device identifier
        hostname:
          type: string
          description: Device hostname
        status:
          $ref: "#/components/schemas/DeviceStatus"
        os:
          type: string
          description: Operating system
        ip_address:
          type: string
          description: Primary IP address
        last_seen:
          type: string
          format: date-time
          description: Last heartbeat timestamp (ISO 8601)
        browser_count:
          type: integer
          description: Number of browsers detected
        prompts_today:
          type: integer
          description: Number of prompts captured today
        total_prompts:
          type: integer
          description: Total number of prompts captured
        registered_at:
          type: string
          format: date-time
          nullable: true
          description: Device registration timestamp (ISO 8601)
      required:
        - id
        - hostname
        - status
        - os
        - ip_address
        - last_seen
        - browser_count
        - prompts_today
        - total_prompts

    Prompt:
      type: object
      properties:
        id:
          type: string
          description: Prompt identifier
        device_id:
          type: string
          nullable: true
          description: Associated device ID
        site:
          type: string
          description: Site where prompt was captured
        prompt_text:
          type: string
          description: The prompt text
        timestamp:
          type: integer
          format: int64
          description: Timestamp in epoch milliseconds
        browser:
          type: string
          description: Browser name
        is_flagged:
          type: boolean
          description: Whether the prompt is flagged
        url:
          type: string
          nullable: true
          description: URL where prompt was captured
        username:
          type: string
          nullable: true
          description: Username associated with the prompt
      required:
        - id
        - site
        - prompt_text
        - timestamp
        - browser
        - is_flagged

    DeviceEvent:
      type: object
      properties:
        id:
          type: string
          description: Event identifier
        device_id:
          type: string
          nullable: true
          description: Associated device ID
        event_type:
          type: string
          description: Type of event
        severity:
          type: string
          enum: [info, warning, critical]
          description: Event severity level
        description:
          type: string
          description: Event description
        timestamp:
          type: integer
          format: int64
          description: Timestamp in epoch milliseconds
        site:
          type: string
          nullable: true
          description: Site associated with event
        browser_name:
          type: string
          nullable: true
          description: Browser name
        profile_name:
          type: string
          nullable: true
          description: Browser profile name
        username:
          type: string
          nullable: true
          description: Username
        url:
          type: string
          nullable: true
          description: URL associated with event
        prompt:
          type: string
          nullable: true
          description: Prompt text if applicable
        hostname:
          type: string
          nullable: true
          description: Hostname
      required:
        - id
        - event_type
        - severity
        - description
        - timestamp

    DeviceEventsResponse:
      type: object
      properties:
        events:
          type: array
          items:
            $ref: "#/components/schemas/DeviceEvent"
        stats:
          type: object
          properties:
            total:
              type: integer
              description: Total number of events
            critical:
              type: integer
              description: Number of critical events
            warning:
              type: integer
              description: Number of warning events
            info:
              type: integer
              description: Number of info events
          required:
            - total
            - critical
            - warning
            - info
      required:
        - events
        - stats

    BlockedPrompt:
      type: object
      properties:
        id:
          type: string
          description: Blocked prompt identifier
        device_id:
          type: string
          description: Associated device ID
        site:
          type: string
          description: Site where prompt was blocked
        reason:
          type: string
          description: Reason for blocking
        timestamp:
          type: string
          format: date-time
          description: Timestamp when prompt was blocked (ISO 8601)
      required:
        - id
        - device_id
        - site
        - reason
        - timestamp

    AuditTrailItem:
      type: object
      description: Unified audit trail item merging all event sources
      properties:
        id:
          type: string
          description: Item identifier
        type:
          type: string
          enum: [device_event, prompt, compliance_event, browser_event]
          description: Type of audit trail item
        timestamp:
          type: integer
          format: int64
          description: Timestamp in epoch milliseconds
        severity:
          type: string
          enum: [info, warning, critical]
          description: Event severity level (if applicable)
        event_type:
          type: string
          description: Event type/category
        device_id:
          type: string
          nullable: true
          description: Associated device ID
        description:
          type: string
          nullable: true
          description: Event description
        site:
          type: string
          nullable: true
          description: Site associated with event
        browser_name:
          type: string
          nullable: true
          description: Browser name
        profile_name:
          type: string
          nullable: true
          description: Browser profile name
        username:
          type: string
          nullable: true
          description: Username
        url:
          type: string
          nullable: true
          description: URL associated with event
        prompt:
          type: string
          nullable: true
          description: Prompt text (for device events)
        prompt_text:
          type: string
          nullable: true
          description: Prompt text (for prompts)
        is_flagged:
          type: boolean
          nullable: true
          description: Whether prompt is flagged
        event_id:
          type: string
          nullable: true
          description: Compliance event ID
        detected_at:
          type: string
          nullable: true
          format: date-time
          description: When compliance event was detected
        user_context:
          type: string
          nullable: true
          description: User context for compliance event
        details:
          type: object
          nullable: true
          description: Additional details (JSONB)
        resolved:
          type: boolean
          nullable: true
          description: Whether compliance event is resolved
        reason:
          type: string
          nullable: true
          description: Reason for compliance event/blocking
        instance_id:
          type: string
          nullable: true
          description: Browser instance ID
        browser_version:
          type: string
          nullable: true
          description: Browser version
        hostname:
          type: string
          nullable: true
          description: Hostname
      required:
        - id
        - type
        - timestamp
        - event_type

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          description: Error message
      required:
        - error

    Alert:
      type: object
      description: Alert derived from device events with warning or critical severity
      properties:
        id:
          type: string
          description: Alert identifier
        device_id:
          type: string
          nullable: true
          description: Associated device ID
        alert_type:
          type: string
          description: Type of alert
        severity:
          type: string
          enum: [warning, critical]
          description: Alert severity
        matched_pattern:
          type: string
          description: Pattern that triggered the alert
        timestamp:
          type: integer
          format: int64
          description: Timestamp in epoch milliseconds
      required:
        - id
        - alert_type
        - severity
        - matched_pattern
        - timestamp

    # Request/Response schemas for POST endpoints

    RegisterDeviceRequest:
      type: object
      description: Request body for device registration
      properties:
        device_id:
          type: string
          description: Unique device identifier
        public_key_pem:
          type: string
          description: Device public key in PEM format for JWT verification
        hostname:
          type: string
          description: Device hostname
        macs:
          type: array
          items:
            type: string
          description: List of MAC addresses
        ips:
          type: array
          items:
            type: string
          description: List of IP addresses
        os:
          type: string
          description: Operating system
        browsers:
          type: array
          items:
            type: string
          description: List of detected browsers
      required:
        - device_id
        - public_key_pem
        - hostname

    RegisterDeviceResponse:
      type: object
      properties:
        status:
          type: string
          description: Registration status
        device_id:
          type: string
          description: Registered device ID
        message:
          type: string
          description: Success message
      required:
        - status
        - device_id
        - message

    HeartbeatRequest:
      type: object
      description: Request body for device heartbeat (optional metadata)
      properties:
        device_id:
          type: string
          description: Device ID (required until auth is implemented)
        device_metadata:
          type: object
          properties:
            hostname:
              type: string
            ips:
              type: array
              items:
                type: string
            macs:
              type: array
              items:
                type: string
            os:
              type: string
      required:
        - device_id

    HeartbeatResponse:
      type: object
      properties:
        status:
          type: string
          description: Heartbeat status
        device_id:
          type: string
          description: Device ID
        message:
          type: string
          description: Success message
      required:
        - status
        - device_id
        - message

    CapturePromptRequest:
      type: object
      description: Request body for capturing a prompt
      properties:
        id:
          type: string
          description: UUID v4 message ID
        site:
          type: string
          description: Site where prompt was captured
        url:
          type: string
          description: URL where prompt was captured
        prompt:
          type: string
          description: The prompt text
        timestamp:
          type: integer
          format: int64
          description: Timestamp in epoch milliseconds
        selector:
          type: string
          nullable: true
          description: DOM selector for the prompt input
        conversation_id:
          type: string
          nullable: true
          description: Conversation ID if applicable
        trigger:
          type: string
          nullable: true
          description: What triggered the prompt capture
        page_title:
          type: string
          nullable: true
          description: Page title
        browser_name:
          type: string
          nullable: true
          description: Browser name
        browser_version:
          type: string
          nullable: true
          description: Browser version
        profile_name:
          type: string
          nullable: true
          description: Browser profile name
        username:
          type: string
          nullable: true
          description: Username
        agent_status:
          type: string
          nullable: true
          description: Status of native agent
        instance_id:
          type: string
          nullable: true
          description: Browser instance ID
        extension_version:
          type: string
          nullable: true
          description: Extension version
      required:
        - id
        - site
        - url
        - prompt
        - timestamp

    CapturePromptResponse:
      type: object
      properties:
        status:
          type: string
          description: Capture status
        prompt_id:
          type: string
          description: Captured prompt ID
        message:
          type: string
          description: Success message
      required:
        - status
        - prompt_id
        - message

    RegisterBrowserRequest:
      type: object
      description: Request body for browser instance registration
      properties:
        instance_id:
          type: string
          description: Unique browser instance ID
        browser_name:
          type: string
          description: Browser name (e.g., Chrome, Firefox)
        browser_version:
          type: string
          nullable: true
          description: Browser version
        profile_name:
          type: string
          description: Browser profile name
        profile_path:
          type: string
          nullable: true
          description: Path to browser profile
        extension_id:
          type: string
          nullable: true
          description: Extension ID
        extension_version:
          type: string
          nullable: true
          description: Extension version
      required:
        - instance_id
        - browser_name
        - profile_name

    RegisterBrowserResponse:
      type: object
      properties:
        status:
          type: string
          description: Registration status
        instance_id:
          type: string
          description: Registered browser instance ID
        message:
          type: string
          description: Success message
      required:
        - status
        - instance_id
        - message

    BrowserHeartbeatRequest:
      type: object
      description: Request body for browser heartbeat
      properties:
        instance_id:
          type: string
          description: Browser instance ID
      required:
        - instance_id

    BrowserHeartbeatResponse:
      type: object
      properties:
        status:
          type: string
          description: Heartbeat status
        instance_id:
          type: string
          description: Browser instance ID
        message:
          type: string
          description: Success message
      required:
        - status
        - instance_id
        - message

    ExtensionStatusRequest:
      type: object
      description: Request body for extension status report
      properties:
        instance_id:
          type: string
          description: Browser instance ID
        status:
          type: string
          description: Extension status (e.g., enabled, disabled)
        reported_by:
          type: string
          nullable: true
          description: Who/what reported the status
        metadata:
          type: object
          nullable: true
          description: Additional metadata
      required:
        - instance_id
        - status

    ExtensionStatusResponse:
      type: object
      properties:
        status:
          type: string
          description: Report status
        status_id:
          type: string
          description: Created status record ID
        message:
          type: string
          description: Success message
      required:
        - status
        - status_id
        - message

    ComplianceEventRequest:
      type: object
      description: Request body for compliance event report
      properties:
        instance_id:
          type: string
          nullable: true
          description: Browser instance ID
        event_type:
          type: string
          description: Type of compliance event
        severity:
          type: string
          enum: [info, warning, critical]
          description: Event severity
        detected_at:
          type: string
          format: date-time
          description: When the event was detected (ISO 8601)
        user_context:
          type: string
          nullable: true
          description: User context information
        details:
          type: object
          nullable: true
          description: Additional event details (JSONB)
          properties:
            site:
              type: string
            reason:
              type: string
      required:
        - event_type
        - severity
        - detected_at

    ComplianceEventResponse:
      type: object
      properties:
        status:
          type: string
          description: Report status
        event_id:
          type: string
          description: Created event ID
        message:
          type: string
          description: Success message
      required:
        - status
        - event_id
        - message
